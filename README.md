## EduNext - Разработка образовательной платформы (Backend)
EduNext — это платформа с интерактивными курсами, где AI-репетитор адаптируется под знания каждого студента, подсказывает и проверяет задания.

## Основные возможности
### 1. Аутентификация пользователя
1.1 **Регистрация пользователя (`/api/v1/auth/register`)**
   - Метод: `POST`
   - Описание: регистрация нового пользователя в системе.
   - Входные данные:
     ```json
     {
       "username": "example_user",
       "password": "secure_password",
       "first_name": "Имя",
       "last_name": "Фамилия",
       "age": 25,
       "email": "user@example.com",
       "phone": "tel:+71234567890"
     }
     ```
   - Пароль хешируется с помощью `bcrypt`.
   - Роль пользователя по умолчанию: `USER`.
   - Возвращает видимые данные пользователя без пароля.

1.2 **Вход пользователя (`/api/v1/auth/login`)**
   - Метод: `POST`
   - Описание: аутентификация пользователя по логину и паролю.
   - Входные данные: `OAuth2PasswordRequestForm` (`username`, `password`).
   - Возвращает пару токенов:
     ```json
     {
       "access_token": "...",
       "refresh_token": "..."
     }
     ```
   - Токены формируются с использованием JWT:
     - **Access token**: срок действия по умолчанию 15 минут.
     - **Refresh token**: срок действия по умолчанию 24 часа.

1.3 **Обновление access-токена (`/api/v1/auth/refresh`)**
   - Метод: `POST`
   - Описание: получение нового access-токена по refresh-токену.
   - Входные данные:
     ```json
     {
       "refresh_token": "..."
     }
     ```
   - Возвращает новый access-токен при валидном refresh-токене.

1.4 **Получение информации о текущем пользователе (`/api/v1/auth/me`)**
   - Метод: `GET`
   - Описание: получение данных о пользователе, соответствующем текущему токену.
   - Входные данные: access-токен в заголовке `Authorization: Bearer <token>`.
   - Возвращает приветственное сообщение с именем пользователя.

### Безопасность и механизмы работы

- **Реализована система OAuth 2.0**.
- **Хеширование паролей**: используется `passlib` с алгоритмом `bcrypt`.
- **JWT-токены**: библиотека `jose` для генерации и проверки токенов.
  - Access и refresh токены содержат `sub` (username) и `user_id`.
- **Проверка токенов**:
  - `get_user` декодирует JWT, проверяет срок действия и возвращает информацию о пользователе.
  - В случае истекшего или некорректного токена возвращается соответствующий HTTP-статус (`401` или `404`).
- **Роли пользователей**: система поддерживает роли (`Пользователь`, `Администратор`) для разграничения доступа.

### 2. Система управления курсами и уроками (CRUD)

Система позволяет создавать, получать, подписываться на курсы и уроки, а также управлять прогрессом пользователей. Все операции защищены авторизацией и выполняются через **FastAPI** с использованием асинхронных вызовов к базе данных.

### Курсы

1. **Добавление курса (`/api/v1/course/addCourse`)**
   - Метод: `POST`
   - Описание: позволяет авторизованному пользователю создать новый курс.
   - Входные данные:
     ```json
     {
       "course_title": "Название курса",
       "desc": "Описание курса",
       "course_categories": "Категория1, Категория2"
     }
     ```
   - Автор курса определяется автоматически на основе текущего пользователя.
   - Возвращает сообщение об успешном создании курса с данными курса.

2. **Получение курса (`/api/v1/course/getCourse`)**
   - Метод: `GET`
   - Параметры запроса:
     - `name` (необязательный) — название курса
     - `id_` (необязательный) — идентификатор курса
   - Возвращает список курсов, согласно указанным фильтрам (если ничего не указано, значит будут выданы все курсы)

3. **Обновление курса (`/api/v1/course/updateCourse`)**
   - Метод: `PATCH`
   - Параметры запроса:
     - `course_id` (обязательный) — айди курса
     - `changes` (обязательный) — изменения в формате словаря: `{"attr": "new_value"}`, где ключи означают колонки, которые будут изменены, а значения - новые значения в этих колонках.
   - Изменяет разрешенные колонки в базе данных, таблице `Courses`. (возможно изменить только свои курсы)

4. **Удаление курса (`/api/v1/course/deleteCourse`)**
   - Метод: `DELETE`
   - Параметры запроса:
     - `course_id` (обязательный) — айди курса
   - Удаляет курс, если пользователь является автором. (также удаляет все лекции из этого курса)

5. **Подписка на курс (`/api/v1/course/sign`)**
   - Метод: `POST`
   - Позволяет пользователю начать изучение курса и создать запись о прогрессе.
   - Входные данные:
     ```json
     {
       "course_id": 1
     }
     ```
   - Возвращает данные о созданной записи прогресса пользователя.

---

### Уроки

1. **Добавление урока (`/api/v1/lesson/addLesson`)**
   - Метод: `POST`
   - Только автор курса может добавлять уроки.
   - Урок может быть:
     - Лекцией (`LECTURE`) — без вопроса и ответа
     - Практической лекцией (`PRACTICAL`) — с вопросом, ответом и количеством попыток
   - Входные данные:
     ```json
     {
       "lesson_title": "Название урока",
       "course_id": 1,
       "desc": "Описание урока",
       "material": "Учебный материал",
       "question_lesson": "Вопрос",
       "answer_lesson": "Правильный ответ",
       "attempts": 3,
       "level": 1
     }
     ```
   - Возвращает сообщение об успешном добавлении урока с его данными.
   - level определяется числом от 1 до 3 (*Чем больше - тем сложнее*)

2. **Получение всех уроков курса (`/api/v1/lesson/getLessons`)**
   - Метод: `GET`
   - Параметры запроса:
     - `course_id` — идентификатор курса
   - Возвращает список всех уроков курса.

3. **Обновление урока в курсе (`/api/v1/lesson/updateLesson`)**
   - Метод: `PATCH`
   - Параметры запроса:
     - `course_id` (обязательный) — айди курса
     - `lesson_id` (обязательный) — айди урока в курсе
     - `changes` (обязательный) — изменения в формате словаря: `{"attr": "new_value"}`, где ключи означают колонки, которые будут изменены, а значения - новые значения в этих колонках.
   - Изменяет разрешенные колонки в базе данных, таблице `Lessons`. (возможно изменить только свои уроки)

4. **Удаление урока из курса (`/api/v1/lesson/deleteLesson`)**
   - Метод: `DELETE`
   - Параметры запроса:
     - `course_id` (обязательный) — айди курса
     - `lesson_id` (обязательный) — айди урока в курсе
   - Удаляет урок в курсе, если пользователь является его автором. (при этом изменяет количество уроков в сущности `Courses`)

5. **Подписка на урок (`/api/v1/lesson/sign`)**
   - Метод: `POST`
   - Позволяет пользователю начать изучение урока и создать запись о прогрессе.
   - Входные данные:
     ```json
     {
       "lesson_id": 1
     }
     ```
   - Возвращает данные о созданной записи прогресса пользователя.

6. **Завершение урока**
   - **Практический урок (`/api/v1/lesson/answerLesson`)**
     - Пользователь отправляет свой ответ на практическую задачу.
     - Проверяется правильность ответа и количество оставшихся попыток.
     - Обновляется статус прогресса пользователя.
   - **Лекционный урок (`/api/v1/lesson/completeLesson`)**
     - Позволяет отметить лекцию как пройденную.
     - Обновляется статус прогресса пользователя и количество пользователей, завершивших урок.

---

### Безопасность и механизмы работы

- Все операции требуют авторизации пользователя (`Depends(security.get_user)`).
- Перед добавлением урока проверяется, что текущий пользователь является автором курса.
- Для практических уроков контролируется количество попыток на выполнение.
- Статус прогресса пользователя хранится в базе данных и обновляется при подписке или завершении урока.
- Все ошибки и некорректные действия возвращают стандартизированный JSON с соответствующим HTTP-статусом.

---

### Примеры использования

**Добавление курса:**
```bash
POST /api/v1/course/addCourse
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "course_title": "Python для начинающих",
  "desc": "Базовый курс по Python",
  "course_categories": "Программирование, Python"
}
```
### 3. Работа с задачами от ИИ

Система предоставляет возможность создавать интерактивные задания и получать ответы с помощью встроенного AI-ассистента. Методы обеспечивают генерацию, проверку и хранение задач, а также контроль прогресса пользователя.

---


1. **Задание вопроса AI-помощнику (`/api/v1/lesson/{lesson_id}/ask`)**
   - Метод: `POST`
   - Позволяет пользователю задать вопрос по содержимому урока.
   - Входные данные:
     ```json
     {
       "question": "Вопрос"
     }
     ```
   - Алгоритм работы:
     1. Получение данных урока (название, описание, материал).
     2. Формирование запроса для AI-ассистента (метод `get_answer_ai`).
     3. Возврат ответа от AI в JSON формате.
    - Промт: "Ты — AI-репетитор. Название урока: {lesson_name}. Описание урока: {lesson_desc}. Контекст урока: '{lesson_material}'. Вопрос студента: '{user_question}'. Дай развернутый, но четкий ответ, основанный на предоставленных данных. Если ответа в данных нет, так и скажи."
   - Пример ответа:
     ```json
     {
       "data": "В этой задаче говорится о способности градиентного бустинга обучаться на ошибках прошлых деревьев в ансамбле"
     }
     ```

2. **Генерация задачи по уроку (`/api/v1/lesson/{lesson_id}/generate-task`)**
   - Метод: `POST`
   - Позволяет сгенерировать задачу на основе контекста урока.
   - Алгоритм работы:
     1. Получение информации о уроке.
     2. Вызов функции генерации задачи (`generate_task`), которая возвращает JSON с полями `task` и `answer`.
     3. Сохранение задачи в базе данных с привязкой к пользователю.
   - Промт: "Ты — AI-репетитор. Сгенерируй одну практическую задачу по теме: '{lesson_name}', описание темы: {lesson_desc}. Задача должна быть уникальной и проверять понимание ключевых концепций. Уровень сложности — начальный. Предоставь также эталонное решение для проверки. Ответ пришли СТРОГО В JSON формате с ключами 'task' и 'answer'. В ответе должен быть чистый JSON без форматирования текста и специальных символов."
   - Пример JSON сгенерированной задачи:
     ```json
     {
       "task": "Решите пример: 2 + 2",
       "answer": "4" 
     }
     ```
     Здесь я добавил в промт обязательное условие: генерация задачи и ответа в JSON-формате, чтобы было удобнее парсить данные и записывать их в бд.

3. **Ответ на задачу AI (`/api/v1/lesson/{task_id}/answer-ai-task`)**
   - Метод: `POST`
   - Позволяет пользователю отправить свой ответ на задачу, сгенерированную AI-репетитором.
   - Алгоритм работы:
     1. Получение задачи по ID и проверка статуса выполнения.
     2. Сравнение ответа пользователя с правильным ответом (`compare_answers`).
     3. В случае успешного выполнения обновляется статус задачи и прогресса пользователя.
     4. В случае ошибки возвращается сообщение о неверном ответе.
   - Промт: "Ты - AI-репетитор. Сравни ответ студента '{user_answer}' с эталонным решением '{true_answer}'. Является ли ответ студента верным? Ответь ТОЛЬКО 'true' или 'false'." 
   - Входные данные:
     ```json
     {
       "answer": "Ответ на задачу от ИИ"
     }
     ```
     Здесь ключевой момент был в обработке ответа от AI, нужно было преобразовать его в булевое, я решил пойти максимально легким путем - конвертировал строку в JSON-строку.

4. **Получение списка задач пользователя (`/api/v1/lesson/get-ai-tasks`)**
   - Метод: `GET`
   - Возвращает все задачи, которые сгенерировал AI для конкретного пользователя.
   - Алгоритм работы:
     1. Получение ID пользователя через авторизацию.
     2. Извлечение всех задач, связанных с пользователем.
     3. Возврат данных в виде JSON с полями `id`, `task` и статусом выполнения.

---

### Используемые функции AI

- `get_answer_ai(lesson_name, lesson_desc, material, question)`  
  Генерирует ответ AI на вопрос пользователя, используя контекст урока.

- `generate_task(lesson_name, lesson_desc)`  
  Создаёт задачу на основе информации из урока. Возвращает JSON с полями `task` и `answer`.

- `compare_answers(user_answer, true_answer)`  
  Проверяет правильность ответа пользователя по сравнению с эталонным ответом.

---

### Механизмы безопасности и прогресса

- Все операции требуют авторизации пользователя.
- Задачи привязываются к конкретному пользователю.
- Статус выполнения каждой задачи хранится в базе данных.
- При повторной отправке ответа проверяется, была ли задача уже выполнена.

---

### 4. Система достижений
#### Основные компоненты

1. **Achievement**
   - Класс, описывающий отдельное достижение пользователя.
   - Содержит следующие атрибуты:
     - `achievement_name` — название достижения.
     - `user_id` — идентификатор пользователя.
     - `badge_id` — идентификатор бейджа в базе данных.

2. **BadgeRules**
   - Класс, содержащий правила выдачи достижений.
   - Каждое правило — это асинхронный метод, который проверяет условие для пользователя.
   - Пример правила `first_rule`:
     - Название достижения: `"Всемогущий"`.
     - Условие: у пользователя `success_in_a_row == 10` (решено 10 задач подряд без ошибок).
     - Если условие выполняется, возвращается объект `Achievement`; иначе — возвращается название достижения без выдачи.

3. **BadgeScanStatus**
   - Перечисление возможных статусов проверки достижения:
     - `SUCCESS` — бейдж успешно выдан.
     - `FAILED` — произошла ошибка при выдаче.
     - `NO_SUCCESS` — условие для выдачи не выполнено.

4. **BadgeDispatcher**
   - Основной класс для проверки и выдачи бейджей пользователю.
   - Использует асинхронный метод `scan()`, который:
     1. Получает список достижений и проверяет каждое правило через `check_rule`.
     2. Вызывает `BadgeMethods.give()` для выдачи бейджа, если условие выполнено.
     3. Возвращает словарь с результатами всех проверок в формате:
        ```python
        {
            "Всемогущий": "Выдано",
            "Все с чего-то начинали": "Не выдано",
            ...
            "Терминатор": ("Ошибка", "Достижение уже выдано"),
        }
        ```
        Такой подход отлично масштабируется, что является основной целью при написании логики достижений.
#### Получение всех достижений пользователя (`/api/v1/badge/myBadges`)

**Метод:** `GET`  
**Описание:** Возвращает список всех достижений, выданных пользователю.  
**Аутентификация:** требуется (через `Depends(security.get_user)`)  
**Алгоритм работы:**
1. Из базы данных `UserBadges` берутся все айди достижений, которые есть у пользователя.
2. Внутри метода идет запрос к базе данных `Badges`, где айди достижений обмениваются на полноценные достижения.
3. Пользователю возвращаются достижения, взятые из базы данных `Badges`.


### 5. Инструкция по запуску проекта 

Этот раздел описывает, как развернуть и запустить проект, включая установку зависимостей, настройку окружения и бекап базы данных.
Требования перед началом:
- PostgreSQL установлен и запущен на вашем компьютере или сервере (требуется либо сам сервер, либо pgAdmin 4 вместе с ним).
- Пользователь с правами на создание базы данных.
- Установленный Python 3.12+
---

### 1. Клонирование репозитория

Сначала клонируйте проект с GitHub:

```bash
git clone https://github.com/Jeson3532/EduNext-Backend.git
cd EduNext-Backend
```
### 2. Создание виртуального окружения

Требуется использовать виртуальное окружение для установки зависимостей:

#### Windows
```bash
python -m venv .venv
.venv\Scripts\activate
```

#### macOS/Linux
```
python3 -m venv .venv
source .venv/bin/activate
```
### 3. Установка зависимостей

Установите все необходимые библиотеки через pip:

```pip install -r requirements.txt```

После этого дождитесь установки всех компонентов проекта.
### 4. Создание базы данных 
Создайте новую базу данных для проекта. Например, через psql:

```bash
# Войти в PostgreSQL
psql -U postgres

# Создать базу данных
CREATE DATABASE cdm_db;

# Выход
\q
```
### 5. Дамп базы данных
После создания базы данных её нужно заполнить требуемой структурой, выполните команду:

```pg_restore -U postgres -d cdm_db -1 src/database/dump_learn_platform.backup```
### 6. Создание .env-файла
Создайте в корне проекта файл ".env", после поместите в него следующее содержимое:
```bash
# База данных
USER=Ваш пользователь
PASSWORD=Ваш пароль
HOST=localhost
PORT=5432
DBNAME=learn_platform
# Безопасность
SECRET_KEY=kQLsKWM23*MSlq@Wvn] # Если требуется - можете сменить
# Yandex GPT
AI_FOLDER_ID=b1cb****0cvl4lcodr
AI_TOKEN=AQVNxv****KosfXFB5iQ # Токен на несколько тысяч генераций (скрыт в целях безопасности)
```
- Данные могут меняться в зависимости от Ваших предпочтений. 
### 7. Запуск API
После создания БД, установки зависимостей и настройки переменных окружения, можно начать тестировать проект. 
```bash
// Команда для запуска API
uvicorn src.api.v1.entry.run:app --reload --host 127.0.0.1 --port 8000
```
